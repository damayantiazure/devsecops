{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
      "_generator": {
        "name": "bicep",
        "version": "0.6.18.56646",
        "templateHash": "1417122466541465793"
      }
    },
    "parameters": {
      "keyvaultName": {
        "type": "string",
        "defaultValue": "[format('kvdevsecops{0}', take(uniqueString(resourceGroup().id), 5))]"
      },
      "webAppName": {
        "type": "string",
        "defaultValue": "juiceshop"
      },
      "appServicePlanName": {
        "type": "string",
        "defaultValue": "[format('sp-devsecops-{0}', take(uniqueString(resourceGroup().id), 5))]"
      },
      "acrName": {
        "type": "string",
        "defaultValue": "[format('acrdevsecops{0}', take(uniqueString(resourceGroup().id), 5))]"
      },
      "containerInstanceName": {
        "type": "string",
        "defaultValue": "[format('sonarq-devsecops-{0}', take(uniqueString(resourceGroup().id), 5))]"
      },
      "tenantId": {
        "type": "string",
        "defaultValue": "[subscription().tenantId]"
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]"
      },
      "envirments": {
        "type": "array",
        "defaultValue": [
          "dev",
          "prod"
        ]
      }
    },
    "resources": [
      {
        "type": "Microsoft.ContainerInstance/containerGroups",
        "apiVersion": "2021-10-01",
        "name": "[parameters('containerInstanceName')]",
        "location": "[parameters('location')]",
        "properties": {
          "sku": "Standard",
          "containers": [
            {
              "name": "[parameters('containerInstanceName')]",
              "properties": {
                "image": "sonarqube",
                "ports": [
                  {
                    "protocol": "TCP",
                    "port": 9000
                  }
                ],
                "environmentVariables": [],
                "resources": {
                  "requests": {
                    "memoryInGB": 4,
                    "cpu": 2
                  }
                }
              }
            }
          ],
          "restartPolicy": "Always",
          "ipAddress": {
            "ports": [
              {
                "protocol": "TCP",
                "port": 9000
              }
            ],
            "type": "Public",
            "dnsNameLabel": "[parameters('containerInstanceName')]"
          },
          "osType": "Linux"
        }
      },
      {
        "type": "Microsoft.Web/serverfarms",
        "apiVersion": "2021-03-01",
        "name": "[parameters('appServicePlanName')]",
        "location": "[parameters('location')]",
        "sku": {
          "tier": "Basic",
          "name": "B1"
        },
        "kind": "linux",
        "properties": {
          "perSiteScaling": false,
          "elasticScaleEnabled": false,
          "maximumElasticWorkerCount": 2,
          "isSpot": false,
          "reserved": true,
          "isXenon": false,
          "hyperV": false,
          "targetWorkerCount": 0,
          "targetWorkerSizeId": 0,
          "zoneRedundant": false
        }
      },
      {
        "type": "Microsoft.ContainerRegistry/registries",
        "apiVersion": "2021-12-01-preview",
        "name": "[parameters('acrName')]",
        "location": "[parameters('location')]",
        "sku": {
          "name": "Standard"
        },
        "properties": {
          "adminUserEnabled": true,
          "policies": {
            "quarantinePolicy": {
              "status": "disabled"
            },
            "trustPolicy": {
              "type": "Notary",
              "status": "disabled"
            },
            "retentionPolicy": {
              "days": 7,
              "status": "disabled"
            },
            "exportPolicy": {
              "status": "enabled"
            }
          },
          "encryption": {
            "status": "disabled"
          },
          "dataEndpointEnabled": false,
          "publicNetworkAccess": "Enabled",
          "networkRuleBypassOptions": "AzureServices",
          "zoneRedundancy": "Disabled",
          "anonymousPullEnabled": false
        }
      },
      {
        "type": "Microsoft.KeyVault/vaults",
        "apiVersion": "2021-11-01-preview",
        "name": "[parameters('keyvaultName')]",
        "location": "[parameters('location')]",
        "properties": {
          "sku": {
            "family": "A",
            "name": "standard"
          },
          "accessPolicies": [],
          "tenantId": "[parameters('tenantId')]",
          "publicNetworkAccess": "Enabled"
        }
      },
      {
        "copy": {
          "name": "webApp",
          "count": "[length(parameters('envirments'))]"
        },
        "type": "Microsoft.Web/sites",
        "apiVersion": "2021-03-01",
        "name": "[format('{0}-{1}-devsecops-{2}', parameters('webAppName'), parameters('envirments')[copyIndex()], take(uniqueString(resourceGroup().id), 5))]",
        "location": "[parameters('location')]",
        "kind": "app,linux,container",
        "identity": {
          "type": "SystemAssigned"
        },
        "properties": {
          "enabled": true,
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]",
          "reserved": true,
          "isXenon": false,
          "hyperV": false,
          "siteConfig": {
            "numberOfWorkers": 1,
            "linuxFxVersion": "[format('DOCKER|{0}/juiceshopgit:1', reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))).loginServer)]",
            "acrUseManagedIdentityCreds": false,
            "alwaysOn": true,
            "http20Enabled": true,
            "functionAppScaleLimit": 0,
            "minimumElasticInstanceCount": 0,
            "appSettings": [
              {
                "name": "DOCKER_REGISTRY_SERVER_URL",
                "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))).loginServer]"
              },
              {
                "name": "DOCKER_REGISTRY_SERVER_USERNAME",
                "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2021-12-01-preview').username]"
              },
              {
                "name": "DOCKER_REGISTRY_SERVER_PASSWORD",
                "value": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), '2021-12-01-preview').passwords[0].value]"
              },
              {
                "name": "WEBSITES_ENABLE_APP_SERVICE_STORAGE",
                "value": "false"
              }
            ]
          },
          "scmSiteAlsoStopped": false,
          "clientAffinityEnabled": true,
          "clientCertEnabled": false,
          "clientCertMode": "Required",
          "hostNamesDisabled": false,
          "containerSize": 0,
          "dailyMemoryTimeQuota": 0,
          "httpsOnly": false,
          "redundancyMode": "None",
          "keyVaultReferenceIdentity": "SystemAssigned"
        },
        "dependsOn": [
          "[resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName'))]",
          "[resourceId('Microsoft.Web/serverfarms', parameters('appServicePlanName'))]"
        ]
      }
    ]
  }